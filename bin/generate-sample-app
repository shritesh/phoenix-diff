#!/bin/bash

set -e

if [ $# -ne 1 ]; then
  echo "USAGE: ${0} <phoenix-app-version>"
  exit 1
fi

SAMPLE_APP_DIR="${PWD}/data/sample-app"
export MIX_ARCHIVES="${PWD}/tmp/archives"
PHOENIX_GIT="${PWD}/tmp/phoenix"

phoenix_version=${1}

if [ $1 = "master" ]; then

  if [ -d ${PHOENIX_GIT} ]; then
    echo "Deleting existing temp Phoenix git at ${PHOENIX_GIT}"
    rm -fr ${PHOENIX_GIT}
  fi

  echo "Cloning Phoenix master"
  git clone https://github.com/phoenixframework/phoenix ${PHOENIX_GIT} --depth 1

  phoenix_version=$(awk '$1 == "@version" {print $2}' ${PHOENIX_GIT}/mix.exs | sed 's/\"//g')
fi

sample_app_path="${PWD}/data/sample-app/${phoenix_version}"

if [ -d ${sample_app_path} ]; then
  echo "Deleting existing sample app at ${sample_app_path}"
  rm -fr ${sample_app_path}
fi

if [ -d ${MIX_ARCHIVES} ]; then
  echo "Deleting existing temp mix archives at ${MIX_ARCHIVES}"
  rm -fr ${MIX_ARCHIVES}
fi

echo "Installing Hex"
mix local.hex --force

if [ $1 = "master" ]; then
  echo "Generating phx_new mix archive for ${phoenix_version}"

  pushd ${PHOENIX_GIT}/installer
  MIX_ENV=prod mix do archive.build, archive.install --force
  popd
else
  echo "Installing phx_new mix archive for ${phoenix_version}"
  mix archive.install hex phx_new ${phoenix_version} --force
fi

echo "Generating new sample app for ${phoenix_version}"
echo n | mix phx.new ${sample_app_path} --module SampleApp --app sample_app

echo "Replacing secret keys with default"

replace_in_file() {
  sed -i.bak "${1}" ${2}
  rm ${2}.bak
}

replace_in_file 's/secret_key_base:.*/secret_key_base: "aaaaaaaa"/g' ${sample_app_path}/config/prod.secret.exs
replace_in_file 's/secret_key_base:.*/secret_key_base: "aaaaaaaa",/g' ${sample_app_path}/config/config.exs
replace_in_file 's/signing_salt:.*/signing_salt: "aaaaaaaa"]/g' ${sample_app_path}/config/config.exs
replace_in_file 's/signing_salt:.*/signing_salt: "aaaaaaaa"/g' ${sample_app_path}/lib/sample_app_web/endpoint.ex

# The prod secrets file is ignored due to the .gitignore file within the sample app, so
# we need to forcefully add it in

echo "Adding sample app to git"
git add ${sample_app_path}

echo "Adding prod.secret.exs file to git"
git add -f ${sample_app_path}/config/prod.secret.exs
